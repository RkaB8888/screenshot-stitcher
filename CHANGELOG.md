# Changelog

## \[Unreleased]

* TBD

## 2025-09-07

### Added

* `--early-stop` / `--no-early-stop` CLI 옵션 추가

  * conf==1.0 && 충분한 겹침 면적일 때 조기 종료
* `--min-valid-frac` CLI 옵션 추가

  * 조기 종료 시 요구되는 최소 겹침 비율 제어 가능

### Changed

* 겹침 후보를 단순 반복 → **겹침 면적 내림차순 탐색**으로 최적화
* 대규모 이미지 스티칭 시 탐색 성능 개선 (29장 기준 약 11분 단축)

### Fixed

* 겹침 영역이 없는 경우 후보 리스트 비어있을 때 안전하게 0 반환

## 2025-09-09

### Problem
- 베젤까지 덮어쓰기가 되면서 결과물에 베젤로 인한 손상 발견 (베젤: conf < 1.0)

### Added
- **거리 기반 안티-베젤 스티칭**: `conf==1.0`이 아닌 페어가 하나라도 있으면, 겹치는 픽셀에서 **각 이미지의 전역 중심까지의 거리**를 비교하여 더 가까운 쪽의 픽셀을 선택하는 방식으로 베젤(불일치) 제거.
  - 신규 함수: `_stitch_all_distance(imgs, positions)`
  - 내부 소유자 맵(owner map) `owner(H,W)`를 사용해 픽셀 단위로 “현재 소유자”를 추적하고, 후보 이미지가 더 중심에 가까우면 교체.

- **정합 품질 기록**: 인접 페어의 정합 신뢰도(`conf`)를 수집하여 `pair_confs`로 반환.  
  - `_accumulate_positions(...) -> (positions, gm, pair_confs)` 형태로 변경.

### Changed
- **스티칭 분기 로직**:
  - 모든 페어가 `conf==1.0`이면 기존의 빠른 덮어쓰기 경로(`_stitch_all`) 사용.
  - 하나라도 `conf<1.0`이면 거리 기반 스티칭(`_stitch_all_distance`) 사용.
- **진행률 체감 개선(매칭 단계)**: 후보 목록(`candidates`) 대비 진행 퍼센트로 보고하여 막대 진행이 보다 균일하게 보임. (기존 dy-행 기준과 체감만 다르고 기능은 동일)

### Notes
- 거리 기반 스티칭은 베젤 제거에 집중하며 **블렌딩 없이 한쪽 픽셀만 선택**함. (베젤 정보 혼합 방지)
- 메모리 사용량이 캔버스 크기에 비례해 **`int32` owner 맵(H×W)** 만큼 증가.
- 실행 시간은 겹침 면적과 이미지 수에 따라 스티칭 단계에서 **일정 부분 증가**할 수 있음(매칭 단계 변경 없음). 모든 페어가 완전일치(`conf==1.0`)인 경우에는 기존과 동일한 속도.

### Migration
- `_accumulate_positions`의 반환값이 `(positions, gm, pair_confs)`로 바뀌었으므로, 호출부가 있다면 새 시그니처에 맞춰야 함.

## 2025-09-12

### Problem
- 베젤끼리의 일치율 계산에서 conf=1.0이 나오면서 베젤끼리 스티칭됨.

### Changed
- 기본 동작에서 `--early-stop` 비활성화 → 작은 영역의 우연한 완전일치에 휘둘리지 않고 안정적 매칭 우선.
- 후보 선택 로직 개선:
  - conf > 0.8 조건에서만 갱신
  - 동일 conf에서는 유효 픽셀 수가 많은 쪽, 동률이면 이동량(|dx|+|dy|)이 더 작은 쪽을 우선
- 기본 direction 옵션을 `horizontal`로 변경.

### Fixed
- 거리 기반 스티칭에서 **동일 픽셀값은 최신 owner로 갱신**되도록 처리 → 베젤 잔존 현상 방지.

## 2025-09-13

### Problem
- 너무 긴 코드와 수정이 힘듦.

### Changed
- 코드 구조를 모듈 단위(`cli`, `io_utils`, `preprocess`, `overlap`, `pipeline`, `stitch`, `progress`)로 분리.
- 엔트리포인트를 `main.py`로 단순화하고, 내부 로직은 각 모듈에서 관리하도록 리팩터링.
- 기능 변경 없음, 기존 CLI 옵션 및 출력 결과는 동일.

## 2025-09-15

### Problem

* 베젤 부분이 점수 계산에 포함되어 `conf=1.0`로 잘못 판정되면서, 실제 스티칭에서는 베젤끼리 덮어쓰는 현상 발생.
* 기존 점수 계산식이 복잡하여 디버깅이 어려웠음.

### Added

* **`--bezel` CLI 옵션**: `left,top,right,bottom` 형식으로 베젤 영역을 지정. 지정된 베젤은 매칭 점수 계산 시 무시됨.
* **`--sample-step` CLI 옵션**: 점수 계산 시 사용할 균등 그리드 서브샘플링 간격 지정 (기본 4).

### Changed

* 점수 계산 방식을 **이진 단순화**:

  * |A–B| ≤ tol 이면 1점, 아니면 0점.
  * conf = score / norm 구조로 단순화.
* `_accumulate_positions` 반환값 확장:

  * `(positions, gm, pair_confs, pair_scores, pair_norms)` 로 변경, 각 페어의 정합 품질(score/norm)도 추적 가능.
* 스티칭 로직을 **베젤 유무로 분기**:

  * `--bezel`이 모두 0이면 `_stitch_all` (단순 덮어쓰기).
  * 하나라도 >0이면 `_stitch_all_distance` (거리 기반 승자 규칙).

### Fixed

* 베젤 영역이 conf 계산에 포함되지 않도록 내부 마스크(`_inner_mask`)를 추가하여, 베젤끼리의 잘못된 완전일치(conf=1.0) 방지.

### Notes

* `--tol` 기본값을 0으로 변경: 동일 캡처 전제. 필요 시 1\~3 정도로 조정 권장.
* `--conf-min` 기본값을 0.80으로 강화해, 품질이 낮은 매칭에 대해 경고가 출력되도록 개선.

### Removed

* `--early-stop` / `--no-early-stop` CLI 옵션 제거.
* `--min-valid-frac` CLI 옵션 제거 (로직 단순화 목적).

## 2025-09-16

### Problem

* 스티칭 작업이 굉장히 오래 걸림.

### Added

* **중앙 k×k 미니체크:** 후보의 중앙 패치(기본 5×5)에서 모든 픽셀이 tol 이하일 때만 정밀 계산 대상으로 채택.

* **정밀 계산 진행률 표시:** 후보 선별(match) 단계와 정밀 계산(refine) 단계를 분리하여 진행률 표시.

### Changed

* `--sample-step` 기본값을 8로 변경.

* `--bezel` 기본값을 `20,20,20,20`으로 변경.

### Fixed

* 미니체크 통과 후보가 0개일 경우, 겹침 없음으로 판단 후 direction 기준 안전 오프셋 반환.

## 2025-09-17

### Problem

* 문서 스티칭에서 **미니체크(k×k 중앙 패치)**가 균일 영역(흰 배경)에서는 유효성이 낮아 실행 시간이 과도하게 길어짐.

* `cv2.absdiff()` 사용 시 반환 배열 차원(`(N,1)` vs `(N,)`) 불일치로 인해 boolean mask 인덱싱 단계에서 **IndexError** 발생.

### Troubleshooting

* `cv2.absdiff()` 대신 **numpy 연산(`np.abs`)**을 사용하여 차원 안정성을 확보.

* 1D 라인 비교 시 `(N,)` 형태로 일관성 유지하도록 수정.

* 이후 테스트에서 동일 오류가 재발하지 않음.

### Add

* CLI 인자 `--prelim-refine` 추가.

* 배열 차원 문제 발생 시 예외 추적을 쉽게 하기 위한 **디버깅 로깅 코드** 일부 강화.

### Change

* 프리체크 로직을 **라인 기반 검사**(행/열 단일선)으로 변경.

* 필요 시 `--prelim-refine` 옵션으로 **중앙 k×k 미니체크** 추가 지원.

* `--sample-step` 기본값을 2로 조정하여 계산 속도 최적화.
