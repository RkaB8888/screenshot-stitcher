# Changelog

## \[Unreleased]

* TBD

## 2025-09-07

### Added

* `--early-stop` / `--no-early-stop` CLI 옵션 추가

  * conf==1.0 && 충분한 겹침 면적일 때 조기 종료
* `--min-valid-frac` CLI 옵션 추가

  * 조기 종료 시 요구되는 최소 겹침 비율 제어 가능

### Changed

* 겹침 후보를 단순 반복 → **겹침 면적 내림차순 탐색**으로 최적화
* 대규모 이미지 스티칭 시 탐색 성능 개선 (29장 기준 약 11분 단축)

### Fixed

* 겹침 영역이 없는 경우 후보 리스트 비어있을 때 안전하게 0 반환

## 2025-09-09

### Added
- **거리 기반 안티-베젤 스티칭**: `conf==1.0`이 아닌 페어가 하나라도 있으면, 겹치는 픽셀에서 **각 이미지의 전역 중심까지의 거리**를 비교하여 더 가까운 쪽의 픽셀을 선택하는 방식으로 베젤(불일치) 제거.
  - 신규 함수: `_stitch_all_distance(imgs, positions)`
  - 내부 소유자 맵(owner map) `owner(H,W)`를 사용해 픽셀 단위로 “현재 소유자”를 추적하고, 후보 이미지가 더 중심에 가까우면 교체.

- **정합 품질 기록**: 인접 페어의 정합 신뢰도(`conf`)를 수집하여 `pair_confs`로 반환.  
  - `_accumulate_positions(...) -> (positions, gm, pair_confs)` 형태로 변경.

### Changed
- **스티칭 분기 로직**:
  - 모든 페어가 `conf==1.0`이면 기존의 빠른 덮어쓰기 경로(`_stitch_all`) 사용.
  - 하나라도 `conf<1.0`이면 거리 기반 스티칭(`_stitch_all_distance`) 사용.
- **진행률 체감 개선(매칭 단계)**: 후보 목록(`candidates`) 대비 진행 퍼센트로 보고하여 막대 진행이 보다 균일하게 보임. (기존 dy-행 기준과 체감만 다르고 기능은 동일)

### Notes
- 거리 기반 스티칭은 베젤 제거에 집중하며 **블렌딩 없이 한쪽 픽셀만 선택**함. (베젤 정보 혼합 방지)
- 메모리 사용량이 캔버스 크기에 비례해 **`int32` owner 맵(H×W)** 만큼 증가.
- 실행 시간은 겹침 면적과 이미지 수에 따라 스티칭 단계에서 **일정 부분 증가**할 수 있음(매칭 단계 변경 없음). 모든 페어가 완전일치(`conf==1.0`)인 경우에는 기존과 동일한 속도.

### Migration
- `_accumulate_positions`의 반환값이 `(positions, gm, pair_confs)`로 바뀌었으므로, 호출부가 있다면 새 시그니처에 맞춰야 함.
